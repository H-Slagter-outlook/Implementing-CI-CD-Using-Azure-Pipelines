{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]"
        },
        "environmentName": {
            "type": "string",
            "defaultValue": "test"
        },
        "registryName": {
            "type": "string",
            "defaultValue": "packtadocicd"
        }
    },
    "variables": {
        "containerAppName": "[concat(parameters('environmentName'), '-packt-store-cart')]",
        "containerAppEnvName": "[concat(variables('containerAppName'), '-env')]",
        "redisContainerName": "[concat(parameters('environmentName'), '-redis')]",
        "redisDnsNameLabel": "[concat(parameters('environmentName'), '-packt-store-redis')]"
    },
    "resources": [
        {
            "location": "[parameters('location')]",
            "name": "[variables('redisContainerName')]",
            "type": "Microsoft.ContainerInstance/containerGroups",
            "apiVersion": "2023-05-01",
            "zones": [],
            "properties": {
                "containers": [
                    {
                        "name": "[variables('redisContainerName')]",
                        "properties": {
                            "image": "docker.io/redis/redis-stack:latest",
                            "resources": {
                                "requests": {
                                    "cpu": 1,
                                    "memoryInGB": 1
                                }
                            },
                            "ports": [
                                {
                                    "port": "6379",
                                    "protocol": "TCP"
                                }
                            ]
                        }
                    }
                ],
                "restartPolicy": "OnFailure",
                "osType": "Linux",
                "sku": "Standard",
                "ipAddress": {
                    "type": "Public",
                    "ports": [
                        {
                            "port": "6379",
                            "protocol": "TCP"
                        }
                    ],
                    "dnsNameLabel": "[variables('redisDnsNameLabel')]",
                    "autoGeneratedDomainNameLabelScope": "TenantReuse"
                }
            },
            "tags": {}
        },
        {
            "apiVersion": "2022-11-01-preview",
            "name": "[variables('containerAppEnvName')]",
            "type": "Microsoft.App/managedEnvironments",
            "location": "[parameters('location')]",
            "dependsOn": [],
            "properties": {
                "appLogsConfiguration": {
                    "destination": null,
                    "logAnalyticsConfiguration": null
                }
            }
        },
        {
            "apiVersion": "2022-11-01-preview",
            "name": "[variables('containerAppName')]",
            "type": "Microsoft.App/containerapps",
            "kind": "containerapps",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[concat('Microsoft.App/managedEnvironments/', variables('containerAppEnvName'))]",
                "[concat('Microsoft.ContainerInstance/containerGroups/', variables('redisContainerName'))]"
            ],
            "properties": {
                "environmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]",
                "configuration": {
                    "secrets": [
                        {
                            "name": "packt-registry-secret",
                            "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName')), '2023-01-01-preview').passwords[0].value]"
                        }
                    ],
                    "registries": [
                        {
                            "server": "packtadocicd.azurecr.io",
                            "username": "packtadocicd",
                            "passwordSecretRef": "packt-registry-secret"
                        }
                    ],
                    "activeRevisionsMode": "Single",
                    "ingress": {
                        "external": true,
                        "transport": "Auto",
                        "allowInsecure": true,
                        "targetPort": 5075,
                        "stickySessions": {
                            "affinity": "none"
                        }
                    }
                },
                "template": {
                    "containers": [
                        {
                            "name": "cart",
                            "image": "packtadocicd.azurecr.io/packt-store-cart:latest",
                            "command": [],
                            "resources": {
                                "cpu": 1,
                                "memory": "2Gi"
                            },
                            "env": [
                                {
                                    "name": "NODE_ENV",
                                    "value": "production"
                                },
                                {
                                    "name": "PORT",
                                    "value": "5075"
                                },
                                {
                                    "name": "REDIS_HOST",
                                    "value": "[reference(resourceId('Microsoft.ContainerInstance/containerGroups', variables('redisContainerName'))).ipAddress.fqdn]"
                                },
                                {
                                    "name": "REDIS_PORT",
                                    "value": "6379"
                                }
                            ]
                        }
                    ],
                    "scale": {
                        "minReplicas": 1
                    }
                }
            }
        }
    ],
    "outputs": {
        "containerAppUrl": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.App/containerapps', variables('containerAppName'))).configuration.ingress.fqdn]"
        }
    }
}